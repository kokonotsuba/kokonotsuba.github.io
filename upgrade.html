<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Kokonotsuba!</title>
  <link rel="stylesheet" href="./style.css">
</head>
<body id="main">
  <header>
    <div id="titleArea">
      <h1>Kokonotsuba BBS Software</h1>
      <div class="subtitle wings">by HARD</div>
    </div>

    <nav id="mainNav">
      <ul>
        <li><a class="navlink" href="main.html">Index</a></li>
        <li><a class="navlink" href="history.html">History</a></li>
        <li><a class="navlink" href="features.html">Features</a></li>
        <li><a class="navlink" href="devs.html">Developers</a></li>
        <li><a class="navlink" href="license.html">License Terms</a></li>
        <li><a class="navlink" href="https://github.com/Heyuri/kokonotsuba/" target="_blank">Repository</a></li>
        <li><a class="navlink" href="setup.html">Set Up</a></li>
        <li><a class="navlink" href="upgrade.html">Upgrade</a></li>
        <li><a class="navlink" href="//img.heyuri.net/b/" target="_blank">Example Board</a></li>
        <li><a class="navlink" href="//cgi.heyuri.net/devchat/" target="_blank">Dev Chat</a></li>
      </ul>
    </nav>
  </header>

  <main>
    <h2 id="welcome">Upgrading instructions</h2>

    <div class="centerText">
      <img class="randomImage" height="400" src="https://img.heyuri.net/c/randomimg2.php" alt="Random image from 2D Cute@Heyuri" title="Random image from 2D Cute@Heyuri">
    </div>

    <h2>SQL Commands</h2>
    <p>As Kokonotsuba is updated, the structure of the database may change. To adapt, run these commands starting from the date of your last upgrade to the latest version:</p>
    <p>2025/08/24<br><code>ALTER TABLE threads ADD COLUMN is_sticky BOOL DEFAULT FALSE;</code></p>
    <p>2025/08/27<br><code>ALTER TABLE posts ADD COLUMN poster_hash VARCHAR(255) DEFAULT NULL;</code></p>
    <p>2025/08/27<br><pre>CREATE TABLE deleted_posts (
	id INT AUTO_INCREMENT PRIMARY KEY,
	post_uid INT NOT NULL,          -- FK to posts(id)
	board_uid INT NOT NULL,         -- FK to boards(id) (copied from post at delete time)
	deleted_by INT NULL,            -- FK to users(id)
	deleted_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
	file_only TINYINT(1) DEFAULT 0,
	by_proxy TINYINT(1) DEFAULT 0,

	note TEXT NULL,                 -- optional moderator note

	-- restore fields (NULL until restored)
	restored_at TIMESTAMP NULL,
	restored_by INT NULL,           -- FK to users(id)

	-- generated flag: 1 when open (restored_at IS NULL), 0 otherwise
	open_flag TINYINT(1) AS (IF(restored_at IS NULL, 1, 0)) STORED,
	
	
	-- helper column for uniqueness: only filled when open
	open_post_uid INT AS (CASE WHEN restored_at IS NULL THEN post_uid ELSE NULL END) STORED,

	-- FKs (adjust ON DELETE as you prefer)
	CONSTRAINT fk_dp_post FOREIGN KEY (post_uid) REFERENCES posts(post_uid) ON DELETE CASCADE,
	CONSTRAINT fk_dp_board FOREIGN KEY (board_uid) REFERENCES boards(board_uid) ON DELETE CASCADE,

	-- Handy indexes
	KEY idx_post_uid (post_uid),
	KEY idx_board_deleted_at (board_uid, deleted_at),
	KEY idx_deleted_by_deleted_at (deleted_by, deleted_at),
	KEY idx_restored_at (restored_at),

	-- Enforce: at most one open row per post_uid
	UNIQUE KEY uq_open_post_uid (open_post_uid)
) ENGINE=InnoDB;
</pre> <br>and<br> <pre>CREATE TABLE files (
	id INT AUTO_INCREMENT PRIMARY KEY,
	post_uid INT NOT NULL,
	file_name TEXT NOT NULL,
	stored_filename TEXT NOT NULL,
	file_ext VARCHAR(16) NOT NULL,
	file_md5 VARCHAR(600) NOT NULL,
	file_width INT DEFAULT NULL,
	file_height INT DEFAULT NULL,
	file_size BIGINT UNSIGNED NULL,
	mime_type VARCHAR(255) NULL,
	is_hidden TINYINT(1)  NOT NULL DEFAULT 0,
	is_thumb TINYINT(1) NOT NULL DEFAULT 0,

	CONSTRAINT fk_file_post_uid FOREIGN KEY (post_uid) REFERENCES posts(post_uid) ON DELETE CASCADE,

	-- Index for file_md5
	KEY idx_md5 (file_md5),

	-- Additional indexes
	KEY idx_post_uid (post_uid),  -- For queries filtering by post_uid
	KEY idx_file_ext (file_ext),  -- For queries filtering by file extension
	KEY idx_file_size (file_size), -- For queries filtering by file size
	KEY idx_file_name_prefix (file_name(255)), -- Prefix index for file_name (adjust length as necessary)
	KEY idx_mime_type (mime_type), -- For queries filtering by mime_type

	-- Composite index for queries filtering by both post_uid and file_md5
	KEY idx_post_uid_file_md5 (post_uid, file_md5)
) ENGINE=InnoDB;</pre></p>
   
</main>
</body>
</html>
